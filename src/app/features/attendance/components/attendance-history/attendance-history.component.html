<!-- src/app/features/attendance/components/attendance-history/attendance-history.component.html -->
<div class="attendance-history">

  <!-- Filtros -->
  <div class="filters-container">
    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Fecha inicio</mat-label>
      <input
        matInput
        [matDatepicker]="startPicker"
        [formControl]="startDateControl">
      <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Fecha fin</mat-label>
      <input
        matInput
        [matDatepicker]="endPicker"
        [formControl]="endDateControl">
      <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <button
      mat-raised-button
      color="primary"
      (click)="loadAttendances()"
      [disabled]="loading">
      <mat-icon>search</mat-icon>
      Buscar
    </button>

    <button
      mat-button
      (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Limpiar
    </button>

    <div class="spacer"></div>

    <button
      mat-stroked-button
      (click)="exportToCSV()"
      [disabled]="dataSource.data.length === 0">
      <mat-icon>download</mat-icon>
      Exportar CSV
    </button>
  </div>

  <!-- Filtro de búsqueda rápida -->
  <mat-form-field appearance="outline" class="search-field">
    <mat-label>Buscar en resultados</mat-label>
    <input
      matInput
      (keyup)="applyFilter($event)"
      placeholder="Curso, grupo, etc.">
    <mat-icon matPrefix>search</mat-icon>
  </mat-form-field>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Cargando historial...</p>
  </div>

  <!-- Tabla -->
  <div class="table-container" *ngIf="!loading">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      class="attendance-table">

      <!-- Columna: Fecha -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
        <td mat-cell *matCellDef="let row">
          <div class="date-cell">
            <mat-icon>calendar_today</mat-icon>
            {{ formatDate(row.attendanceDate) }}
          </div>
        </td>
      </ng-container>

      <!-- Columna: Curso -->
      <ng-container matColumnDef="course">
        <th mat-header-cell *matHeaderCellDef>Curso</th>
        <td mat-cell *matCellDef="let row">
          <div class="course-cell">
            <strong>{{ row.classSession?.course.name || 'N/A' }}</strong>
            <span class="course-code">{{ row.classSession?.course.code || '' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Columna: Grupo -->
      <ng-container matColumnDef="group">
        <th mat-header-cell *matHeaderCellDef>Grupo</th>
        <td mat-cell *matCellDef="let row">
          {{ row.classSession?.studentGroup.name || 'N/A' }}
        </td>
      </ng-container>

      <!-- Columna: Entrada -->
      <ng-container matColumnDef="checkIn">
        <th mat-header-cell *matHeaderCellDef>Entrada</th>
        <td mat-cell *matCellDef="let row">
          <div class="time-cell" *ngIf="row.checkinAt">
            <mat-icon class="time-icon">login</mat-icon>
            {{ formatTime(row.checkinAt) }}
          </div>
          <span class="no-data" *ngIf="!row.checkinAt">-</span>
        </td>
      </ng-container>

      <!-- Columna: Salida -->
      <ng-container matColumnDef="checkOut">
        <th mat-header-cell *matHeaderCellDef>Salida</th>
        <td mat-cell *matCellDef="let row">
          <div class="time-cell" *ngIf="row.checkoutAt">
            <mat-icon class="time-icon">logout</mat-icon>
            {{ formatTime(row.checkoutAt) }}
          </div>
          <span class="no-data" *ngIf="!row.checkoutAt">Pendiente</span>
        </td>
      </ng-container>

      <!-- Columna: Duración -->
      <ng-container matColumnDef="duration">
        <th mat-header-cell *matHeaderCellDef>Duración</th>
        <td mat-cell *matCellDef="let row">
          <div class="duration-cell" *ngIf="row.actualDurationMinutes">
            <mat-icon>schedule</mat-icon>
            {{ timeUtils.minutesToReadableString(row.actualDurationMinutes) }}
          </div>
          <span class="no-data" *ngIf="!row.actualDurationMinutes">-</span>
        </td>
      </ng-container>

      <!-- Columna: Penalizaciones -->
      <ng-container matColumnDef="penalties">
        <th mat-header-cell *matHeaderCellDef>Penalizaciones</th>
        <td mat-cell *matCellDef="let row">
          <div class="penalties-cell">
            <mat-chip
              *ngIf="row.lateMinutes > 0"
              class="penalty-chip late"
              matTooltip="Llegada tarde">
              <mat-icon>warning</mat-icon>
              {{ row.lateMinutes }} min
            </mat-chip>
            <mat-chip
              *ngIf="row.earlyDepartureMinutes > 0"
              class="penalty-chip early"
              matTooltip="Salida anticipada">
              <mat-icon>exit_to_app</mat-icon>
              {{ row.earlyDepartureMinutes }} min
            </mat-chip>
            <span class="no-penalty" *ngIf="getTotalPenaltyMinutes(row) === 0">
              <mat-icon>check_circle</mat-icon>
              Sin penalizaciones
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Columna: Estado -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let row">
          <mat-chip [color]="getStatusColor(row.status)" selected>
            {{ getStatusName(row.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Header y rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Sin datos -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data-message">
            <mat-icon>inbox</mat-icon>
            <p>No se encontraron registros de asistencia</p>
          </div>
        </td>
      </tr>
    </table>

    <!-- Paginador -->
    <mat-paginator
      [pageSizeOptions]="[10, 25, 50, 100]"
      [pageSize]="10"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
